<html>
  <head>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
	//This script takes an input file submitted by a user and plots it using the google charts API
	//20130528 Morten Albring
	var reader; 
	reader = new FileReader();
	function readText(filePath) {
	var output = ""; 
        if(filePath.files && filePath.files[0]) {           
            reader.onload = function (e) {
                output = e.target.result;
                orderContents(output);
            };
            reader.readAsText(filePath.files[0]);
        }
        return output;
    }   
    orderContents = function (txt) {
		var txt_lines = txt.split('\n');
		var number_of_lines = txt_lines.length;		
		
		//Initatilising arrays
		//First column is field values
		//Second column is absorption values
		//Third colum is going to be the first derivative of col 2 wrt col 1
		var eprData= [[0,0],[0,0],[0,0]];
		var firstCol = [],
		 secondCol = [],
		 thirdCol = [],
		 tempData = [];

		 //eprData["firstCol"] = firstCol;
		 //eprData["secondCol"] = secondCol;
		 //eprData["thirdCol"] = thirdCol;
		//console.log(eprData);
		
		
		var str = "";
		for (var i=0;i<number_of_lines-2;i++) {
		//Lines are parsed into columns by specific formatting of my data
		//Probably a more robust, more general way of doing this
		firstCol[i] = parseFloat(txt_lines[i].substring(0,25));
		secondCol[i] = parseFloat(txt_lines[i].substring(27,44));
		//console.log(tempData);
		if (i >= 1) {

		//Calcualtes derivative
		thirdCol[i] = ((secondCol[i] - secondCol[i-1]) / (firstCol[i] - firstCol[i-1]));
		
		//console.log(i);
		//console.log(tempData[0]);
		tempData[0] = firstCol[i];
		tempData[1] = thirdCol[i];
		eprData[i] = tempData;

		}
		else {
		
		thirdCol[i] = 0;
		//console.log(eprData[0]);
		tempData[0] = firstCol[i];
		tempData[1] = thirdCol[i];
		eprData[i] = tempData;
		}
		tempData = [];
		
	

		}
//console.log(eprData[200]);
		d3Plot(eprData);
 eprData = [];
    	}   

	d3Plot = function (eprData)	{  
		var data = eprData;


		console.log(data[0]);
        var margin = {top:20, right: 15, bottom:60, left:60},
        	width = 960 - margin.left- margin.right,
        	height = 500 - margin.top - margin.bottom;

        var x = d3.scale.linear()
        			.domain([0,d3.max(data,function(d){return d[0];})])
        			.range([0, width]);

        var y = d3.scale.linear()
        			.domain([d3.min(data,function(d){return d[1];}), d3.max(data,function(d){return d[1];})])
        			.range([height, 0]);

        var chart = d3.select('body')
        			.append('svg:svg')
        			.attr('widht', width + margin.right + margin.left)
        			.attr('height',height + margin.top + margin.bottom)
        			.attr('class','chart');

        var main = chart.append('g')
        			.attr('transform','translate('+ margin.left + ',' + margin.top + ')')
        			.attr('width',width)
        			.attr('height',height)
        			.attr('class','main');

        var xAxis = d3.svg.axis()
        			.scale(x)
        			.orient('bottom');
        var line = d3.svg.line()
        			.x(function(d,i){
        				return x(d[0]);
        			})
        			.y(function(d){
        				return y(d[1]);
        			})
        	main.append('g')
        		.attr('transform','translate(0,'+ height + ')')
        		.attr('class','main axis date')
        		.call(xAxis);

        var yAxis = d3.svg.axis()
        				.scale(y)
        				.orient('left');

        	main.append('g')
        		.attr('transform','translate(0,0)')
        		.attr('class','main axis date')
        		.attr(yAxis);

        var g = main.append("svg:g");
        	g.append("svg:path")
        		.data(data)
        		.attr("class","line")
        		.attr("stroke","steelblue")
        		.attr("fill","none")
        		.attr("stroke-width",3)
        		.attr("d",line(data));
        		
        	

        	g.selectAll("scatter-dots")
        		.data(data)
        		.enter().append("svg:circle")
        		.attr("cy",function(d){return y(d[1]);})
        		.attr("cx", function(d,i){return x(d[0]);})
        		.attr("r", 1)
        		.style("opacity", 1);
//
//function(d,i) {return x(d[0]); }
      }
    </script>
  </head>
  <body>
    
	    <div id="container">    
        <input type="file" onchange='readText(this)' />
        <br/>
        <hr/>   
        <h3>Contents of the Text file:</h3>
        <div id="main">
            ...
        </div>
    </div>
  </body>
</html>